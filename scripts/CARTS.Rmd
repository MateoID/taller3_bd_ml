---
title: "CARTS"
output: html_document
---

Configuración inicial

```{r}

require(pacman)

p_load(
  tidyverse,
  tidymodels,
  ggplot2,
  plotly,
  leaflet,
  sf,
  visdat,
  geojsonsf,
  geojsonio,
  jsonlite,
  purrr,
  stringr,
  tm,
  stringi,
  skimr,
  tidyverse, 
  rpart, 
  caret ,  
  rpart.plot, 
  Metrics, 
  MLmetrics, 
  ipred,  
  ranger, 
  themis
  )

raw_data_path <- './data'
db_train <- readRDS(file.path(raw_data_path, 'train.rds'))
db_test <- readRDS(file.path(raw_data_path, 'test.rds'))

# Verificando la estructura de la base de datos 
str(db_train)  
head(db_train)
summary(db_train)

```

# CARTs

## Modelo básico

Entrenando un arbol para regresión con la especificación más sencilla

```{r}
#Definición de la grilla 
grid <- expand.grid(cp = 0.001)

#Especificación sencilla 
cart_model_1 <- price ~ 
  property_type + cai_mts + tm_mts + sitp_100m + ciclorutas_mts + invasiones_100m +   median_m2  + parqueaderos + parque + avenidas  + 
  gimnasio + duplex + piscina 
  

#Entrenamiento del modelo con validación cruzada
db_modelo_clean <- db_train %>% 
  drop_na(all_of(vars_modelo))

modelo_cart_1 <- train(cart_model_1,
                      data = db_modelo_clean,
                      method = "rpart", 
                      trControl = trainControl(method = 'cv', number = 5),
                      tuneGrid = grid,
                      metric = "RMSE")

# Visualiza el mejor hiperparámetro
modelo_cart_1$bestTune

#Visualización del árbol 
rpart.plot(modelo_cart_1$finalModel)

#Métricas de validación cruzada
#print(modelo_cart_1)

```

```{r}
#Predicción con base de testeo 
pred_test <- predict(modelo_cart_1, db_test)

#Preparamos los resultados
entrega_1 <- data.frame(
  property_id = db_test$property_id,
  price = as.vector(pred_test) 
)

entrega_1 <- entrega_1 %>%
  mutate(price = round(price)) %>%
  distinct(property_id, .keep_all = TRUE)

# Guardar el CSV
write.csv(entrega_1, file = "submission_CARTs_cp_001.csv", row.names = FALSE)
```

## Modelos con nuevas variables

```{r}

#Modelo 2 

#Definición de la grilla 
grid <- expand.grid(cp = 0.01)


#Especificación 2  
db_train$densidad_servicios <- rowSums(cbind(
  db_train$cai_mts < 500,
  db_train$tm_mts < 500,
  db_train$parque == 1,
  db_train$sitp_100m < 300,
  db_train$ciclorutas_mts < 200
))

db_train$log_price <- log(db_train$price)

cart_model_2 <- log_price ~ 
  property_type + densidad_servicios + median_m2 + parqueaderos + 
  parque + avenidas + gimnasio + duplex + piscina + desposito + 
  terraza + univ_mts + hospital_mts + area_imputed


#Entrenamiento del modelo con validación cruzada
modelo_cart_2 <- train(cart_model_2,
                      data = db_train,
                      method = "rpart", 
                      trControl = trainControl(method = 'cv', number = 5),
                      tuneGrid = grid,
                      metric = "RMSE")

# Visualiza el mejor hiperparámetro
modelo_cart_1$bestTune

#Métricas de validación cruzada
print(modelo_cart_1)


db_test$densidad_servicios <- rowSums(cbind(
  db_test$cai_mts < 500,
  db_test$tm_mts < 500,
  db_test$parque == 1,
  db_test$sitp_100m < 300,
  db_test$ciclorutas_mts < 200
))

#Predicción con base de testeo 
pred_test2 <- predict(modelo_cart_2, db_test)
pred_test2 <- exp(pred_test2)

#Preparar la submission
entrega_2 <- data.frame(
  property_id = db_test$property_id,
  price = as.vector(pred_test2) 
)

entrega_2 <- entrega_2 %>%
  mutate(price = round(price)) %>%
  distinct(property_id, .keep_all = TRUE)

# Guardar el CSV
write.csv(entrega_1, file = "submission_CARTs2_cp_01.csv", row.names = FALSE)
```
