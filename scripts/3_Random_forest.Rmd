---
title: "random_forest"
output: html_document
date: "2025-05-14"
---

```{r}
require(pacman)

p_load(
  tidyverse,
  caret,
  Metrics,
  ranger,
  spatialsample,
  tidymodels,
  sf,
  yardstick
)
```

```{r}
data <- '../data'
train <- read_rds(file.path(data, 'train.rds'))
test <- read_rds(file.path(data, 'test.rds'))
```

```{r}
train <- train %>% 
  select(-c(
    'city', 
    'month', 
    'surface_total', 
    'surface_covered', 
    'rooms', 
    'operation_type', 
    'title', 
    'description', 
    'geometry',
    'localidad', 
    "localidad_fct",
    'upl', 
    'description_clean',
    'dataset',
    'title_clean'
            )) %>% 
  as.data.frame()

set.seed(1905)
# Creación de particiones:
# - 80% para entrenamiento (bd_tr)
# - 20% para validación (bd_validation)
# Método createDataPartition de caret preserva la distribución de la variable objetivo
inTrain <- createDataPartition(
  y = train$price,     # Variable objetivo
  p = .80,             # Proporción para entrenamiento
  list = FALSE
)

# Filtrado de datos:
bd_tr <- train %>% filter(row_number() %in% inTrain)       # Conjunto de entrenamiento
bd_validation  <- train %>% filter(!row_number() %in% inTrain)
```

```{r}
exclusion_vars <- c("price", "property_id", "geometry", "lon_raw", "lat_raw")

predictors <- setdiff(names(bd_tr), exclusion_vars)

# Unir los nombres con "+"
rhs <- paste(predictors, collapse = " + ")

# Crear la fórmula
especification_forest <- as.formula(paste("price ~", rhs))
```
```{r}
# --- CONFIGURACIÓN DEL MODELO RANDOM FOREST ---
set.seed(1905)  # Reproducibilidad

# Parámetros de control:
# - method = "oob": Usa Out-of-Bag error para validación
fitControl <- trainControl(method = "oob")

# Grid de hiperparámetros:
# - mtry: 3 a 5 variables por división
# - splitrule: "gini" (impureza de Gini)
# - min.node.size: Tamaño mínimo de nodo = 13
tree_grid <- expand.grid(
    mtry = 8,
    splitrule = "variance",
    min.node.size = 2
)

# Entrenamiento del modelo:
# - method = "ranger": Implementación eficiente de RF
# - num.trees = 500: Número de árboles
# - importance = "impurity": Calcula importancia de variables
model_forest <- train(
    especification_forest,        # Fórmula definida previamente
    data = bd_tr,                 # Datos balanceados
    method = "ranger",  
    trControl = fitControl,
    tuneGrid = tree_grid,
    num.trees = 1000,
    importance = "permutation"
)
```


```{r}
# --- CONFIGURACIÓN DEL MODELO RANDOM FOREST CON VALIDACIÓN CRUZADA ESPACIAL ---

# Parámetros de control:
# - method = "10 fold CV": Usa validación cruzada con 10 folds
bd_tr_sf <- st_as_sf(
  bd_tr,
  coords = c("lon_raw", "lat_raw"),
  crs = 4326
)

set.seed(2405)
block_folds <- spatial_block_cv(bd_tr_sf, v = 10)

receta <-  recipe(especification_forest, data = bd_tr_sf) %>% 
  step_naomit(all_predictors(), all_outcomes()) %>%
  step_dummy(all_nominal_predictors()) %>%
  step_zv(all_predictors())  

modelo_rf <- rand_forest(
  mode = "regression",
  trees = 1000,
  mtry = tune(),
  min_n = (),
  ) %>% 
  set_engine(
    "ranger",
    splitrule = "variance",
    importance = "permutation"
    )

grid <- expand.grid(
  mtry = c(9, 21, 29, 37),
  min_n = c(2, 4, 6, 8)
)

workflow <- workflow() %>%
  add_model(modelo_rf) %>%
  add_recipe(receta)


tree_grid <- tune_grid(
  workflow,
  resamples = block_folds,
  grid = grid,
  metrics = metric_set(mae),
  control = control_grid(save_pred = TRUE)
)

collect_metrics(tree_grid)
```

```{r}
best_params <- select_best(tree_grid, metric = "mae")

final_wf <- finalize_workflow(workflow, best_params)

final_fit <- fit(final_wf, data = train)

final_fit <- workflow %>%
  fit(data = train)
```

```{r}
pred <- predict(final_fit, new_data = bd_validation[, predictors])

bd_validation <- bd_validation %>% 
  mutate(price_hat = pred$.pred)

results_df <- data.frame(
  truth = bd_validation$price,
  estimate = bd_validation$price_hat
)

# Calcular MAE correctamente
mae_result1 <- mae(bd_validation, truth = price, estimate = price_hat)
print(mae_result1)
```

```{r}
test <- test %>% 
  select(-c(
    'city', 
    'month', 
    'surface_total', 
    'surface_covered', 
    'rooms', 
    'operation_type', 
    'title', 
    'description', 
    'geometry',
    'localidad', 
    "localidad_fct",
    'upl', 
    'description_clean',
    'dataset',
    'title_clean'
            )) %>% 
  as.data.frame()

pred <- predict(final_fit, new_data = test[, predictors])

test <- test %>% 
  select('property_id') %>% 
  mutate(price = pred$.pred)
```
```{r}
write_csv(test, 'RF_mtry_29_minnode_2_cv_10.csv')
```
